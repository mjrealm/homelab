---
- name: Create repo secret local file
  ansible.builtin.shell:
    cmd: |
      kubectl create secret generic {{ repo_secret_name }} \
      --from-file=sshPrivateKey=$(readlink -f {{ ssh_public_key }}) \
      --from-literal=url={{ git_repo_url }} \
      --from-literal=type=git \
      --dry-run=client \
      -o yaml > {{ repo_secret_file_unsealed }}
    creates: "{{ repo_secret_file_unsealed }}"

- name: Add ArgoCD metadata with yq
  ansible.builtin.shell:
    cmd: |
      yq -i '.metadata.name = "{{repo_secret_name}}"' {{ repo_secret_file_unsealed }}
      yq -i '.metadata.namespace = "argocd"' {{ repo_secret_file_unsealed }}
      yq -i '.metadata.labels["argocd.argoproj.io/secret-type"] = "repository"' {{ repo_secret_file_unsealed }}

- name: Seal the secret
  ansible.builtin.command:
    cmd: |
      kubeseal -f {{ repo_secret_file_unsealed }} -w {{ repo_secret_file_sealed }}
    creates: "{{ repo_secret_file_sealed }}"

- name: Delete unsealed file
  ansible.builtin.file:
    path: "{{ repo_secret_file_unsealed }}"
    state: absent
