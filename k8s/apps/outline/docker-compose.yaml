version: "3.2"
services:
  outline:
    image: docker.getoutline.com/outlinewiki/outline:latest
    environment:
      - NODE_ENV=production
      - SECRET_KEY=42abb5c6c5d5e12dd62be50abdeba8cbf2ad2e12756bee25cb8e8ef8967376d0
      - UTILS_SECRET=aabd32be6a65ebfa553c7aa0671523164080463a836a13e9ffc764532c71537a
      - DATABASE_URL=postgres://user:pass@postgres:5432/outline
      - DATABASE_URL_TEST=postgres://user:pass@postgres:5432/outline-test
      - REDIS_URL=redis://redis:6379
      - URL=https://outline.mdeleon.dev
      - PORT=3000
      - FILE_STORAGE=local
      - FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
      - FILE_STORAGE_UPLOAD_MAX_SIZE=26214400
      - GOOGLE_CLIENT_ID=1052569415188-e8ee8er5enjooobkeh0vkb6k1majva9s.apps.googleusercontent.com
      - GOOGLE_CLIENT_SECRET=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
    ports:
      - "3000:3000"
    volumes:
      - storage-data:/var/lib/outline/data
    depends_on:
      - postgres
      - redis
    labels:
      kompose.service.type: clusterip
      kompose.service.expose: outline.mdeleon.dev
      kompose.service.expose.tls-secret: outline-tls-cert
      kompose.volume.size: 20Gi
      cert-manager.io/cluster-issuer: letsencrypt-prod
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: Outline
      gethomepage.dev/description: Wiki
      gethomepage.dev/group: Personal
      gethomepage.dev/icon: outline.png

  redis:
    image: redis
    ports:
      - "6379:6379"

  postgres:
    image: postgres
    ports:
      - "5432:5432"
    volumes:
      - db:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: "user"
      POSTGRES_PASSWORD: "pass"
      POSTGRES_DB: "outline"
      PGDATA: "/var/lib/postgresql/data/pg_data"
    labels:
      kompose.volume.size: 20Gi

volumes:
  storage-data:
  db:
